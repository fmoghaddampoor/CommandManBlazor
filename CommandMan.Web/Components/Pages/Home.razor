@page "/"
@using CommandMan.Web.Services
@using CommandMan.Web.Components
@using CommandMan.Core.Entities
@using CommandMan.Core.Interfaces
@inject AppState AppState
@inject ProgressService ProgressState
@inject IJSRuntime JS
@inject IFileSystemService FileService
@inject Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage.ProtectedLocalStorage LocalStorage
@inject NavigationManager Navigation
@inject FavoritesService FavoritesService
@implements IAsyncDisposable

<PageTitle>CommandMan</PageTitle>

<div class="main-container">
    <ProgressOverlay />
    <!-- Optional Top Toolbar or Menu could go here -->
    
    <div class="panels-container">
        <div class="file-panel @(AppState.ActivePanel == AppState.LeftPanel ? "active" : "")" 
             @onclick="() => Activate(AppState.LeftPanel)">
            <DrivePicker OnDriveSelected="@(path => SetPanelPath(AppState.LeftPanel, path))" />
            <FilePanel State="@AppState.LeftPanel" 
                       IsActive="@(AppState.ActivePanel == AppState.LeftPanel)" 
                       OnActivate="@(() => Activate(AppState.LeftPanel))"
                       OnDropReceived="@(src => HandleDragMove(src, AppState.LeftPanel))" />
        </div>
        
        <div class="file-panel @(AppState.ActivePanel == AppState.RightPanel ? "active" : "")" 
             @onclick="() => Activate(AppState.RightPanel)">
            <DrivePicker OnDriveSelected="@(path => SetPanelPath(AppState.RightPanel, path))" />
            <FilePanel State="@AppState.RightPanel" 
                       IsActive="@(AppState.ActivePanel == AppState.RightPanel)" 
                       OnActivate="@(() => Activate(AppState.RightPanel))"
                       OnDropReceived="@(src => HandleDragMove(src, AppState.RightPanel))" />
        </div>
    </div>
    
    <div class="command-bar">
        <span class="cmd-prefix">@AppState.ActivePanel.CurrentPath&gt;</span>
        <input type="text" class="cmd-input" />
    </div>
    
    <div class="app-footer" style="z-index: 1000;">
        <div class="f-key-btn" @onclick="() => TriggerAction(ActionType.View)">F3 View</div>
        <div class="f-key-btn" @onclick="() => TriggerAction(ActionType.Edit)">F4 Edit</div>
        <div class="f-key-btn" @onclick="() => TriggerAction(ActionType.Copy)">F5 Copy</div>
        <div class="f-key-btn" @onclick="() => TriggerAction(ActionType.Move)">F6 Move</div>
        <div class="f-key-btn" @onclick="() => TriggerAction(ActionType.MkDir)">F7 MkDir</div>
        <div class="f-key-btn" @onclick="() => TriggerAction(ActionType.Delete)">F8 Delete</div>
        <div class="f-key-btn" @onclick="() => TriggerAction(ActionType.NewFile)">F9 NewFile</div>
        <div class="f-key-btn" @onclick="() => TriggerAction(ActionType.Zip)">F10 Zip</div>
        <div class="f-key-btn" @onclick="() => TriggerAction(ActionType.Unzip)">F11 Unzip</div>
    </div>
</div>

@if (IsModalVisible)
{
    <div class="modal-overlay">
        <div class="modal-box">
             <div class="modal-title">@ModalTitle</div>
             @if (ModalAction == ActionType.Zip)
             {
                 <div class="modal-form">
                     <div class="input-group">
                         <label>Archive Name</label>
                         <input @bind="ModalInputValue" id="modalInput" autofocus />
                     </div>
                     <div class="input-group">
                         <label>Compression Level</label>
                         <select @bind="ZipCompressionLevel" class="modal-select">
                             <option value="Optimal">Optimal</option>
                             <option value="Fastest">Fastest</option>
                             <option value="NoCompression">No Compression</option>
                             <option value="SmallestSize">Smallest Size</option>
                         </select>
                     </div>
                 </div>
             }
             else if (ModalAction == ActionType.Unzip)
             {
                  <div class="input-group">
                      <label>Extract to Folder Name</label>
                      <input @bind="ModalInputValue" id="modalInput" autofocus />
                  </div>
             }
             else if (ModalAction == ActionType.Delete)
             {
                 <p style="color:black">Are you sure you want to delete @AppState.ActivePanel.SelectedItem?.Name ?</p>
             }
             else
             {
                 <input @bind="ModalInputValue" id="modalInput" autofocus />
             }
             <div class="modal-buttons">
                 <button @onclick="SubmitModal">OK</button>
                 <button @onclick="CloseModal">Cancel</button>
             </div>
        </div>
    </div>
}

@if (IsManageFavoritesVisible)
{
    var flatItems = GetFlatFavorites();
    <div class="modal-overlay">
        <div class="modal-box" style="width: 750px; max-height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-title">Manage Favorites</div>
            
            <div class="fav-toolbar" style="display: flex; gap: 8px; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                <button class="action-btn" @onclick="MoveFavUp" disabled="@(selectedFavoriteIndex <= 0 || !flatItems.Any())" title="Move Up">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button class="action-btn" @onclick="MoveFavDown" disabled="@(selectedFavoriteIndex == -1 || selectedFavoriteIndex >= flatItems.Count - 1)" title="Move Down">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button class="action-btn" @onclick="OpenRenameFavModal" disabled="@(selectedFavoriteIndex == -1)" title="Rename Favorite">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn" @onclick="AddNewFolder" title="Add Folder">
                    <i class="fas fa-folder-plus"></i>
                </button>
                <div style="flex: 1; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: var(--text-muted); font-size: 0.8rem;">
                    <i class="fas fa-info-circle" style="margin-right: 5px;"></i> Drag to move into folders
                </div>
                <button class="action-btn delete" @onclick="DeleteSelectedFav" disabled="@(selectedFavoriteIndex == -1)" title="Delete Selected">
                    <i class="fas fa-trash"></i>
                </button>
            </div>

            <div style="flex: 1; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px;">
                <table class="file-table" style="width: 100%; border-collapse: separate; border-spacing: 0;">
                    <thead style="position: sticky; top: 0; background: var(--header-bg); z-index: 10;">
                        <tr>
                            <th style="width: 50%; border-bottom: 1px solid var(--border-color);">Name</th>
                            <th style="border-bottom: 1px solid var(--border-color);">Path / Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (flatItems.Any())
                        {
                            @for (int i = 0; i < flatItems.Count; i++)
                            {
                                var index = i;
                                var flat = flatItems[index];
                                <tr class="@(selectedFavoriteIndex == index ? "selected" : "") @(dragOverIndex == index ? "drag-over" : "")" 
                                    @onclick="() => selectedFavoriteIndex = index"
                                    draggable="true"
                                    @ondragstart="() => HandleDragStart(index)"
                                    @ondragover="() => HandleDragOver(index)"
                                    @ondragleave="() => dragOverIndex = -1"
                                    @ondrop="() => HandleDrop(index)"
                                    @ondragover:preventDefault
                                    style="cursor: grab;">
                                    <td style="padding: 4px 12px; padding-left: @(flat.Level * 24 + 12)px;">
                                        <div style="display: flex; align-items: center; gap: 8px; height: 32px;">
                                            @if (flat.Item.IsFolder)
                                            {
                                                <i class="fas fa-folder text-warning"></i>
                                            }
                                            else
                                            {
                                                <i class="fas fa-star text-accent" style="color: var(--accent-color)"></i>
                                            }
                                            <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@flat.Item.Name</span>
                                        </div>
                                    </td>
                                    <td style="padding: 4px 8px; font-family: 'Consolas', monospace; font-size: 0.8rem; color: var(--text-muted);">
                                        @if (flat.Item.IsFolder)
                                        {
                                            <span>[Folder]</span>
                                        }
                                        else
                                        {
                                            <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="@flat.Item.Path">
                                                @flat.Item.Path
                                            </div>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 20px; color: var(--text-muted);">No favorites yet.</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button @onclick="CloseManageFavorites">Close</button>
            </div>
        </div>
    </div>
}

@if (IsRenameModalVisible)
{
    <div class="modal-overlay" style="z-index: 2000;">
        <div class="modal-box" style="width: 450px;">
            <div class="modal-title">Rename Favorite</div>
            <div class="modal-form">
                <div class="input-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Name</label>
                    <input type="text" @bind="RenameModalName" @bind:event="oninput" style="width: 100%;" autofocus />
                </div>
                @if (!RenameModalIsFolder)
                {
                    <div class="input-group">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Path</label>
                        <input type="text" @bind="RenameModalPath" @bind:event="oninput" style="width: 100%;" />
                    </div>
                }
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button @onclick="CloseRenameModal">Cancel</button>
                <button class="primary" @onclick="SubmitRenameModal">OK</button>
            </div>
        </div>
    </div>
}
@code {
    private DotNetObjectReference<Home>? dotNetHelper;
    
    // Modal State
    private bool IsModalVisible = false;
    private bool IsManageFavoritesVisible = false;
    private bool IsRenameModalVisible = false;
    private int selectedFavoriteIndex = -1;
    private int draggedIndex = -1;
    private int dragOverIndex = -1;
    private string ModalTitle = "";
    private string ModalInputValue = "";
    private string RenameModalName = "";
    private string RenameModalPath = "";
    private bool RenameModalIsFolder = false;
    private ActionType ModalAction;
    
    private bool isLeftDragOver = false;
    private bool isRightDragOver = false;
    private int leftDragCounter = 0;
    private int rightDragCounter = 0;
    
    private string ZipCompressionLevel = "Optimal";

    private enum ActionType { None, View, Edit, MkDir, Copy, Move, Delete, NewFile, AddFavorite, Zip, Unzip }

    protected override void OnInitialized()
    {
        AppState.OnChange += StateHasChanged;
        
        // Trigger UI update and auto-save on panel changes
        AppState.LeftPanel.OnChange += async () => { 
            StateHasChanged(); 
            await SavePanelPath(AppState.LeftPanel, "LeftPanelPath");
        };
        AppState.RightPanel.OnChange += async () => { 
            StateHasChanged(); 
            await SavePanelPath(AppState.RightPanel, "RightPanelPath");
        };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            if (firstRender)
            {
                dotNetHelper = DotNetObjectReference.Create(this);
                try { 
                    await JS.InvokeVoidAsync("registerKeyboardHandler", dotNetHelper); 
                    await JS.InvokeVoidAsync("setHomeHelper", dotNetHelper);
                } catch {}
                
                // Load favorites
                await FavoritesService.LoadAsync();
                
                // Load state or Defaults
                await LoadState();
            }
            if (IsModalVisible)
            {
                 // Try to focus input
                 try { await JS.InvokeVoidAsync("eval", "document.getElementById('modalInput')?.focus()"); } catch {}
            }
        }
        catch 
        {
            // Logging removed
        }
    }
    
    private async Task LoadState()
    {
        string leftPath = "";
        string rightPath = "";

        // Check query parameters first
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        
        if (query.TryGetValue("left", out var leftQuery)) leftPath = leftQuery.ToString();
        if (query.TryGetValue("right", out var rightQuery)) rightPath = rightQuery.ToString();

        try 
        {
            if (string.IsNullOrEmpty(leftPath))
            {
                leftPath = await JS.InvokeAsync<string>("loadPanelPath", "LeftPanelPath");
            }
            
            if (string.IsNullOrEmpty(rightPath))
            {
                rightPath = await JS.InvokeAsync<string>("loadPanelPath", "RightPanelPath");
            }
        }
        catch (Exception ex)
        { 
            Console.WriteLine($"LoadState Error: {ex.Message}");
        } 

        // Get default drive for fallback
        var drives = await FileService.GetDrivesAsync();
        var defaultDrive = drives.FirstOrDefault()?.FullPath ?? "C:\\";

        // Validate left path exists, fallback to default drive if not
        if (string.IsNullOrEmpty(leftPath) || !await FileService.ExistsAsync(leftPath))
        {
            leftPath = defaultDrive;
        }

        // Validate right path exists, fallback to default drive if not
        if (string.IsNullOrEmpty(rightPath) || !await FileService.ExistsAsync(rightPath))
        {
            rightPath = defaultDrive;
        }

        Console.WriteLine($"Applying Paths: Left={leftPath}, Right={rightPath}");

        // Apply
        await SetPanelPath(AppState.LeftPanel, leftPath, save: false);
        await SetPanelPath(AppState.RightPanel, rightPath, save: false);
        StateHasChanged();
    }
    
    private async Task SetPanelPath(PanelState panel, string path, bool save = true)
    {
        panel.CurrentPath = path;
        panel.Items = await FileService.GetDirectoryContentAsync(path);
        // Select first item if possible? No, keep selection null or default
        panel.SelectedItem = panel.Items.FirstOrDefault(); // Optional: select first
        panel.NotifyStateChanged();
        
        // Saving is now handled by the OnChange event subscription in OnInitialized
    }

    private async Task SavePanelPath(PanelState panel, string key)
    {
        try
        {
            if (!string.IsNullOrEmpty(panel.CurrentPath))
            {
               await JS.InvokeVoidAsync("savePanelPath", key, panel.CurrentPath);
            }
        }
        catch (Exception ex)
        {
             // Console.WriteLine($"Error saving path for {key}: {ex.Message}");
        }
    }

    private void Activate(PanelState panel)
    {
        AppState.SetActivePanel(panel);
    }

    public class KeyEventArgs {
        public string Key { get; set; } = "";
        public bool ShiftKey { get; set; }
        public bool CtrlKey { get; set; }
        public bool AltKey { get; set; }
    }

    [JSInvokable]
    public async Task HandleKeyDown(KeyEventArgs e)
    {
        if (IsModalVisible)
        {
            if (e.Key == "Enter") await SubmitModal();
            return;
        }

        switch (e.Key)
        {
            case "ArrowUp":
                AppState.ActivePanel.MoveSelection(-1, range: e.ShiftKey);
                break;
            case "ArrowDown":
                AppState.ActivePanel.MoveSelection(1, range: e.ShiftKey);
                break;
            case "Tab":
                if (AppState.ActivePanel == AppState.LeftPanel)
                    AppState.SetActivePanel(AppState.RightPanel);
                else
                    AppState.SetActivePanel(AppState.LeftPanel);
                break;
            case "Enter":
                await HandleEnter();
                break;
            case "F3":
                await TriggerAction(ActionType.View);
                break;
            case "F4":
                await TriggerAction(ActionType.Edit);
                break;
            case "F5":
                await TriggerAction(ActionType.Copy);
                break;
            case "F6":
                await TriggerAction(ActionType.Move);
                break;
            case "F7":
                await TriggerAction(ActionType.MkDir);
                break;
            case "F8":
                await TriggerAction(ActionType.Delete);
                break;
            case "F9":
                await TriggerAction(ActionType.NewFile);
                break;
            case "F10":
                await TriggerAction(ActionType.Zip);
                break;
            case "F11":
                await TriggerAction(ActionType.Unzip);
                break;
            default:
                if (e.Key.Length == 1)
                {
                    if (e.CtrlKey && e.Key.Equals("a", StringComparison.OrdinalIgnoreCase))
                    {
                        var all = AppState.ActivePanel.Items;
                        AppState.ActivePanel.SelectedItems.Clear();
                        foreach(var item in all) AppState.ActivePanel.SelectedItems.Add(item);
                        StateHasChanged();
                    }
                    else
                    {
                        AppState.ActivePanel.SeekItem(e.Key);
                    }
                }
                break;
        }
    }

    private async Task TriggerAction(ActionType action)
    {
        var passive = AppState.ActivePanel == AppState.LeftPanel ? AppState.RightPanel : AppState.LeftPanel;
        
        switch (action)
        {
            case ActionType.View:
                // TODO: Implement View
                break;
            case ActionType.Edit:
                await HandleEdit();
                break;
            case ActionType.Copy:
            case ActionType.Move:
                // Automate: Destination is always the other panel
                ModalAction = action;
                ModalInputValue = passive.CurrentPath;
                await SubmitModal();
                break;
            case ActionType.MkDir:
            case ActionType.Delete:
            case ActionType.NewFile:
            case ActionType.Zip:
            case ActionType.Unzip:
                OpenModal(action);
                break;
        }
    }


    private async Task HandleEdit()
    {
        var item = AppState.ActivePanel.SelectedItem;
        if (item is FileItem)
        {
            await FileService.OpenFileAsync(item.FullPath);
        }
    }
    
    private void OpenModal(ActionType action)
    {
        ModalAction = action;
        IsModalVisible = true;
        
        var passive = AppState.ActivePanel == AppState.LeftPanel ? AppState.RightPanel : AppState.LeftPanel;
        var selectedCount = AppState.ActivePanel.SelectedItems.Count;
        var selectedName = selectedCount > 1 ? $"{selectedCount} items" : (AppState.ActivePanel.SelectedItem?.Name ?? "");
        var activePath = AppState.ActivePanel.CurrentPath;

        switch (action)
        {
            case ActionType.AddFavorite:
                ModalTitle = "Add Favorite Path";
                ModalInputValue = System.IO.Path.GetFileName(activePath.TrimEnd('\\'));
                if (string.IsNullOrEmpty(ModalInputValue)) ModalInputValue = activePath;
                break;
            case ActionType.MkDir:
                ModalTitle = "Create Directory";
                ModalInputValue = "";
                break;
            case ActionType.NewFile:
                ModalTitle = "Create New File";
                ModalInputValue = "";
                break;
            case ActionType.Copy:
                ModalTitle = "Copy " + selectedName + " to:";
                ModalInputValue = passive.CurrentPath; // Default to target panel
                break;
            case ActionType.Move:
                ModalTitle = "Move " + selectedName + " to:";
                ModalInputValue = passive.CurrentPath;
                break;
            case ActionType.Delete:
                ModalTitle = "Delete " + selectedName;
                break;
            case ActionType.Zip:
                ModalTitle = "Pack " + selectedName + " to zip";
                ModalInputValue = "archive.zip";
                break;
            case ActionType.Unzip:
                ModalTitle = "Unzip " + selectedName;
                if (AppState.ActivePanel.SelectedItem != null && AppState.ActivePanel.SelectedItem.Name.EndsWith(".zip", StringComparison.OrdinalIgnoreCase))
                {
                    ModalInputValue = System.IO.Path.GetFileNameWithoutExtension(AppState.ActivePanel.SelectedItem.Name);
                }
                else
                {
                    ModalInputValue = "New Folder";
                }
                break;

        }
        StateHasChanged();
    }
    
    private void CloseModal()
    {
        IsModalVisible = false;
        StateHasChanged();
    }

    private void CloseManageFavorites()
    {
        IsManageFavoritesVisible = false;
        selectedFavoriteIndex = -1;
        StateHasChanged();
    }

    private async Task MoveFavUp()
    {
        var flatItems = GetFlatFavorites();
        if (selectedFavoriteIndex > 0)
        {
             var current = flatItems[selectedFavoriteIndex];
             var list = current.CurrentList;
             int indexInList = list.IndexOf(current.Item);
             if (indexInList > 0)
             {
                 var item = list[indexInList];
                 list.RemoveAt(indexInList);
                 list.Insert(indexInList - 1, item);
                 await FavoritesService.SaveAsync();
             }
        }
    }

    private async Task MoveFavDown()
    {
        var flatItems = GetFlatFavorites();
        if (selectedFavoriteIndex >= 0 && selectedFavoriteIndex < flatItems.Count - 1)
        {
             var current = flatItems[selectedFavoriteIndex];
             var list = current.CurrentList;
             int indexInList = list.IndexOf(current.Item);
             if (indexInList >= 0 && indexInList < list.Count - 1)
             {
                 var item = list[indexInList];
                 list.RemoveAt(indexInList);
                 list.Insert(indexInList + 1, item);
                 await FavoritesService.SaveAsync();
             }
        }
    }

    private void HandleDragStart(int index)
    {
        draggedIndex = index;
    }

    private void HandleDragOver(int index)
    {
        if (draggedIndex != index)
        {
            dragOverIndex = index;
        }
    }

    private async Task HandleDrop(int targetIndex)
    {
        if (draggedIndex == -1 || draggedIndex == targetIndex) return;

        var flatItems = GetFlatFavorites();
        var source = flatItems[draggedIndex];
        var target = flatItems[targetIndex];

        if (target.Item.IsFolder)
        {
            await FavoritesService.MoveToFolder(source.Item, source.CurrentList, target.Item);
        }
        else if (target.Level == 0 && source.Level > 0)
        {
            // Drop on a root item to move out of current folder and into root
            await FavoritesService.MoveToRoot(source.Item, source.CurrentList);
        }

        draggedIndex = -1;
        dragOverIndex = -1;
        StateHasChanged();
    }

    private async Task AddNewFolder()
    {
        await FavoritesService.AddFolder("New Folder");
    }

    private void OpenRenameFavModal()
    {
        var flatItems = GetFlatFavorites();
        if (selectedFavoriteIndex >= 0 && selectedFavoriteIndex < flatItems.Count)
        {
            var item = flatItems[selectedFavoriteIndex].Item;
            RenameModalName = item.Name;
            RenameModalPath = item.Path;
            RenameModalIsFolder = item.IsFolder;
            IsRenameModalVisible = true;
            StateHasChanged();
        }
    }

    private void CloseRenameModal()
    {
        IsRenameModalVisible = false;
        StateHasChanged();
    }

    private async Task SubmitRenameModal()
    {
        var flatItems = GetFlatFavorites();
        if (selectedFavoriteIndex >= 0 && selectedFavoriteIndex < flatItems.Count)
        {
            var item = flatItems[selectedFavoriteIndex].Item;
            await FavoritesService.UpdateFavorite(item, RenameModalName, RenameModalPath);
            IsRenameModalVisible = false;
            StateHasChanged();
        }
    }

    private async Task DeleteSelectedFav()
    {
        var flatItems = GetFlatFavorites();
        if (selectedFavoriteIndex >= 0)
        {
            var current = flatItems[selectedFavoriteIndex];
            current.CurrentList.Remove(current.Item);
            await FavoritesService.SaveAsync();
            
            var newFlat = GetFlatFavorites();
            if (selectedFavoriteIndex >= newFlat.Count)
            {
                selectedFavoriteIndex = newFlat.Count - 1;
            }
        }
    }

    private class FlatFav
    {
        public FavoriteItem Item { get; set; } = null!;
        public List<FavoriteItem> CurrentList { get; set; } = null!;
        public List<FavoriteItem>? ParentList { get; set; }
        public int Level { get; set; }
    }

    private List<FlatFav> GetFlatFavorites()
    {
        var result = new List<FlatFav>();
        Flatten(FavoritesService.GetFavorites(), null, 0, result);
        return result;
    }

    private void Flatten(List<FavoriteItem> items, List<FavoriteItem>? parentList, int level, List<FlatFav> result)
    {
        foreach (var item in items)
        {
            result.Add(new FlatFav { Item = item, CurrentList = items, ParentList = parentList, Level = level });
            if (item.IsFolder)
            {
                Flatten(item.Children, items, level + 1, result);
            }
        }
    }

    private async Task SubmitModal()
    {
        Console.WriteLine($"SubmitModal: {ModalAction} to {ModalInputValue}");
        try 
        {
            var active = AppState.ActivePanel;
            var targetPanel = active == AppState.LeftPanel ? AppState.RightPanel : AppState.LeftPanel;
            var selectedItems = active.SelectedItems.ToList();
            
            // Add current focused item if not in selection
            if (active.SelectedItem != null && !selectedItems.Contains(active.SelectedItem))
            {
                selectedItems.Add(active.SelectedItem);
            }

            if (selectedItems.Count == 0 && ModalAction != ActionType.MkDir)
            {
                CloseModal();
                return;
            }

            CloseModal();

            switch (ModalAction)
            {
                case ActionType.AddFavorite:
                    if (!string.IsNullOrWhiteSpace(ModalInputValue))
                    {
                        await FavoritesService.AddFavorite(ModalInputValue, active.CurrentPath);
                    }
                    break;
                case ActionType.MkDir:
                    if (!string.IsNullOrWhiteSpace(ModalInputValue))
                    {
                        var newPath = System.IO.Path.Combine(active.CurrentPath, ModalInputValue);
                        await FileService.CreateDirectoryAsync(newPath);
                        await ReloadPanel(active);
                        
                        // Select the new folder
                        var newItem = active.Items.FirstOrDefault(i => i.Name.Equals(ModalInputValue, StringComparison.OrdinalIgnoreCase));
                        if (newItem != null) active.SelectItem(newItem);
                    }
                    break;
                case ActionType.NewFile:
                    if (!string.IsNullOrWhiteSpace(ModalInputValue))
                    {
                        var newPath = System.IO.Path.Combine(active.CurrentPath, ModalInputValue);
                        await FileService.CreateFileAsync(newPath);
                        await ReloadPanel(active);
                        
                        // Select the new file
                        var newItem = active.Items.FirstOrDefault(i => i.Name.Equals(ModalInputValue, StringComparison.OrdinalIgnoreCase));
                        if (newItem != null) active.SelectItem(newItem);
                    }
                    break;

                case ActionType.Copy:
                case ActionType.Move:
                    ProgressState.Start(ModalAction == ActionType.Copy ? "Copying..." : "Moving...");
                    int idx = 0;
                    var transferredNames = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
                    
                    foreach (var item in selectedItems)
                    {
                        idx++;
                        var progressValue = (double)idx / selectedItems.Count * 100;
                        ProgressState.Update(progressValue, $"Processing: {item.Name}");
                        
                        var dest = System.IO.Path.Combine(ModalInputValue, item.Name);
                        
                        if (ModalAction == ActionType.Copy)
                            await FileService.CopyItemAsync(item.FullPath, dest);
                        else
                            await FileService.MoveItemAsync(item.FullPath, dest);
                        
                        transferredNames.Add(item.Name);
                    }
                    ProgressState.Stop();
                    await ReloadPanel(active);
                    await ReloadPanel(targetPanel);

                    // Select transferred items in target panel
                    if (transferredNames.Any())
                    {
                        var newItems = targetPanel.Items.Where(i => transferredNames.Contains(i.Name)).ToList();
                        if (newItems.Any())
                        {
                            targetPanel.SelectedItems.Clear();
                            foreach (var ni in newItems) targetPanel.SelectedItems.Add(ni);
                            targetPanel.SelectedItem = newItems.First();
                            targetPanel.NotifyStateChanged();
                            
                            // Also activate the target panel so user sees the result
                            AppState.SetActivePanel(targetPanel);
                        }
                    }
                    break;

                case ActionType.Delete:
                    ProgressState.Start("Deleting...");
                    int dIdx = 0;
                    foreach (var item in selectedItems)
                    {
                        dIdx++;
                        var progressValue = (double)dIdx / selectedItems.Count * 100;
                        ProgressState.Update(progressValue, $"Deleting: {item.Name}");
                        await FileService.DeleteItemAsync(item.FullPath);
                    }
                    ProgressState.Stop();
                    await ReloadPanel(active);
                    break;
                    
                case ActionType.Zip:
                    if (!string.IsNullOrWhiteSpace(ModalInputValue))
                    {
                        ProgressState.Start("Zipping...");
                        
                        var destZipPath = System.IO.Path.Combine(targetPanel.CurrentPath, ModalInputValue);
                        if (!destZipPath.EndsWith(".zip", StringComparison.OrdinalIgnoreCase))
                        {
                            destZipPath += ".zip";
                        }
                        
                        var level = Enum.Parse<System.IO.Compression.CompressionLevel>(ZipCompressionLevel);
                        var sourcePaths = selectedItems.Select(i => i.FullPath).ToList();
                        
                        await FileService.ZipItemsAsync(sourcePaths, destZipPath, level);
                        
                        ProgressState.Stop();
                        await ReloadPanel(targetPanel);
                        
                        // Select the new zip file in passive panel
                        var zipName = System.IO.Path.GetFileName(destZipPath);
                        var newZipItem = targetPanel.Items.FirstOrDefault(i => i.Name.Equals(zipName, StringComparison.OrdinalIgnoreCase));
                        if (newZipItem != null) 
                        {
                            targetPanel.SelectItem(newZipItem);
                            targetPanel.NotifyStateChanged();
                        }
                    }
                    break;

                case ActionType.Unzip:
                     if (active.SelectedItem != null && active.SelectedItem.Name.EndsWith(".zip", StringComparison.OrdinalIgnoreCase))
                     {
                         ProgressState.Start("Unzipping...");
                         var zipPath = active.SelectedItem.FullPath;
                         var destFolder = System.IO.Path.Combine(targetPanel.CurrentPath, ModalInputValue);
                         
                         await FileService.UnzipItemAsync(zipPath, destFolder);
                         
                         ProgressState.Stop();
                         await ReloadPanel(targetPanel);
                         
                         // Select the new folder in passive panel
                         var newFolderItem = targetPanel.Items.FirstOrDefault(i => i.Name.Equals(ModalInputValue, StringComparison.OrdinalIgnoreCase));
                         if (newFolderItem != null)
                         {
                             targetPanel.SelectItem(newFolderItem);
                             targetPanel.NotifyStateChanged();
                                 
                             // Activate target to show result
                             AppState.SetActivePanel(targetPanel);
                         }
                     }
                     break;
            }
        }
        catch (Exception ex)
        {
            ProgressState.Stop();
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private async Task ReloadPanel(PanelState panel)
    {
        panel.Items = await FileService.GetDirectoryContentAsync(panel.CurrentPath);
        panel.NotifyStateChanged();
    }

    private async Task HandleEnter()
    {
        var item = AppState.ActivePanel.SelectedItem;
        if (item is DirectoryItem dir)
        {
            AppState.ActivePanel.CurrentPath = dir.FullPath;
             AppState.ActivePanel.Items = await FileService.GetDirectoryContentAsync(AppState.ActivePanel.CurrentPath);
             AppState.ActivePanel.SelectedItem = null; // Reset selection
             AppState.ActivePanel.NotifyStateChanged();
        }
    }

    private async Task HandleMkDir()
    {
        // Replaced by Modal
    }

    private async Task HandleDelete()
    {
         // Replaced by Modal
    }

    public async ValueTask DisposeAsync()
    {
        AppState.OnChange -= StateHasChanged;
        AppState.LeftPanel.OnChange -= StateHasChanged;
        AppState.RightPanel.OnChange -= StateHasChanged;
        if (dotNetHelper != null)
        {
            try 
            {
                await JS.InvokeVoidAsync("unregisterKeyboardHandler");
            } 
            catch {} 
            dotNetHelper.Dispose();
        }
    }

    private async Task HandleDragMove(PanelState source, PanelState target)
    {
        await Log($"HandleDragMove from {source.CurrentPath} to {target.CurrentPath}");
        if (source == target) return;

        AppState.SetActivePanel(source);
        ModalAction = ActionType.Move;
        ModalInputValue = target.CurrentPath;
        await SubmitModal();
    }

    private async Task Log(string msg)
    {
        try { await JS.InvokeVoidAsync("console.log", "[Debug] " + msg); } catch {}
    }

    [JSInvokable]
    public void OpenAddFavoriteModal()
    {
        OpenModal(ActionType.AddFavorite);
    }

    [JSInvokable]
    public void OpenManageFavoritesModal()
    {
        IsManageFavoritesVisible = true;
        StateHasChanged();
    }

    [JSInvokable]
    public async Task LoadFavoritePath(string path)
    {
        await SetPanelPath(AppState.ActivePanel, path);
    }
}


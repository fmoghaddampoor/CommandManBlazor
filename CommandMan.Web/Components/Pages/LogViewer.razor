@page "/logs"
@using System.IO
@inject IWebHostEnvironment Env
@using CommandMan.Web.Services
@inject ThemeService ThemeService
@implements IDisposable

<h3>Log Viewer</h3>

<div class="log-controls">
    <select @bind="SelectedLogFile" class="log-select">
        <option value="combined">All Logs</option>
        <option value="backend">Backend</option>
        <option value="frontend">Frontend</option>
    </select>
    <button @onclick="LoadLogs" class="log-btn refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
    <button @onclick="ClearLogs" class="log-btn clear-btn"><i class="fas fa-trash-alt"></i> Clear</button>
    <label class="auto-refresh-label">
        <input type="checkbox" @bind="AutoRefresh" /> Auto Refresh (5s)
    </label>
    <div class="log-filters">
        <label><input type="checkbox" @bind="ShowErrors" /> Errors</label>
        <label><input type="checkbox" @bind="ShowWarnings" /> Warnings</label>
        <label><input type="checkbox" @bind="ShowInfo" /> Info</label>
    </div>
</div>

<div class="log-container">
    @if (Logs.Any())
    {
        <table class="log-table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Level</th>
                    <th>Source</th>
                    <th>Context</th>
                    <th>Message</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var log in FilteredLogs)
                {
                    <tr class="log-row @GetLogLevelClass(log.Level)">
                        <td class="col-time">@log.Timestamp</td>
                        <td class="col-level">@log.Level</td>
                        <td class="col-source">@log.Source</td>
                        <td class="col-context">@log.Context</td>
                        <td class="col-message">
                            @if (log.Message.Length > 200)
                            {
                                <button @onclick="() => log.IsExpanded = !log.IsExpanded" class="expand-btn">
                                    @(log.IsExpanded ? "-" : "+")
                                </button>
                            }
                            <div class="message-text @(log.IsExpanded ? "message-expanded" : "message-collapsed")">
                                @log.Message
                            </div>
                        </td>
                    </tr>
                    @if (!string.IsNullOrEmpty(log.Exception))
                    {
                        <tr class="log-row @GetLogLevelClass(log.Level) exception-row">
                            <td colspan="5" class="col-exception">@log.Exception</td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    }
    else
    {
        <div class="no-logs">No logs found or file empty.</div>
    }
</div>

<style>
    .log-controls { 
        display: flex; 
        align-items: center; 
        gap: 15px;
        margin-bottom: 15px; 
        padding: 12px; 
        background: var(--panel-bg); 
        border: 1px solid var(--border-color);
        border-radius: 6px; 
        color: var(--text-main);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    .log-select {
        background: var(--bg-color);
        color: var(--text-main);
        border: 1px solid var(--border-color);
        padding: 6px 12px;
        border-radius: 4px;
        outline: none;
    }
    .log-btn {
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 6px 14px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }
    .log-btn.clear-btn { background: #d83b01; }
    .log-btn.clear-btn:hover { background: #a82a00; transform: translateY(-1px); }
    .log-btn:hover { background: var(--accent-hover); transform: translateY(-1px); }
    .auto-refresh-label { font-size: 0.9rem; cursor: pointer; color: var(--text-muted); }
    .log-filters { display: flex; gap: 10px; margin-left: auto; font-size: 0.9rem; }
    .log-filters label { display: flex; align-items: center; gap: 4px; cursor: pointer; color: var(--text-muted); }
    .log-filters label:hover { color: var(--text-main); }

    .log-container { 
        background: var(--bg-color); 
        color: var(--text-main); 
        padding: 0; 
        font-family: 'Cascadia Code', 'Consolas', monospace; 
        height: calc(100vh - 180px); 
        overflow: auto; 
        border-radius: 8px;
        border: 1px solid var(--border-color);
        box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
    }
    
    .log-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .log-table th { 
        position: sticky; 
        top: 0; 
        background: var(--header-bg); 
        padding: 10px 8px; 
        text-align: left; 
        border-bottom: 2px solid var(--border-color); 
        color: var(--text-muted);
        z-index: 10;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 11px;
    }
    .log-table td { padding: 8px; border-bottom: 1px solid var(--border-color); vertical-align: top; }
    
    .log-row:hover { background: rgba(255, 255, 255, 0.03); }
    
    /* Level Colors */
    .level-err { color: var(--log-err); } 
    .level-err .col-level { font-weight: bold; }
    
    .level-wrn { color: var(--log-wrn); } 
    .level-inf { color: var(--log-inf); } 
    .level-dbg { color: var(--log-dbg); } 
    
    .exception-row td { padding-top: 0; padding-bottom: 12px; font-size: 12px; opacity: 0.9; }
    .col-exception { white-space: pre-wrap; color: var(--log-err); background: rgba(244, 135, 113, 0.03); border-radius: 4px; margin: 4px; }

    .col-time { white-space: nowrap; color: var(--text-muted); width: 180px; }
    .col-level { width: 60px; text-transform: uppercase; }
    .col-source { width: 80px; color: var(--accent-color); opacity: 0.8; }
    .col-context { width: 200px; color: var(--path-color); opacity: 0.8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .col-message { 
        word-break: break-all; 
        position: relative;
    }
    .message-text {
        transition: max-height 0.3s ease;
    }
    .message-collapsed {
        max-height: 4.5em; /* Approximately 3 lines */
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }
    .message-expanded {
        max-height: none;
    }
    .expand-btn {
        background: var(--panel-bg);
        color: var(--text-main);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        width: 20px;
        height: 20px;
        line-height: 18px;
        text-align: center;
        cursor: pointer;
        font-family: monospace;
        font-weight: bold;
        float: left;
        margin-right: 8px;
        margin-top: 2px;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    .expand-btn:hover {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }

    .no-logs { padding: 30px; color: var(--text-muted); text-align: center; font-style: italic; }
</style>

@code {
    private string SelectedLogFile = "combined";
    private bool AutoRefresh = false;
    private bool ShowErrors = true;
    private bool ShowWarnings = true;
    private bool ShowInfo = true;
    private List<LogEntry> Logs = new();
    private System.Threading.Timer? _timer;

    private IEnumerable<LogEntry> FilteredLogs => Logs.Where(log => 
        (ShowErrors && (log.Level == "ERR" || log.Level == "FAT")) ||
        (ShowWarnings && log.Level == "WRN") ||
        (ShowInfo && (log.Level == "INF" || log.Level == "DBG" || log.Level == "VRB"))
    );

    public class LogEntry
    {
        public string Timestamp { get; set; } = "";
        public string Level { get; set; } = "";
        public string Source { get; set; } = "";
        public string Context { get; set; } = "";
        public string Message { get; set; } = "";
        public string Exception { get; set; } = "";
        public bool IsExpanded { get; set; } = false;
    }

    protected override void OnInitialized()
    {
        LoadLogs();
        _timer = new System.Threading.Timer(async _ => 
        {
            if (AutoRefresh)
            {
                await InvokeAsync(() => 
                {
                    LoadLogs();
                    StateHasChanged();
                });
            }
        }, null, 5000, 5000);

        ThemeService.OnThemeChanged += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ThemeService.LoadThemeAsync();
        }
    }

    private void LoadLogs()
    {
        try
        {
            var logDir = Path.Combine(Env.ContentRootPath, "logs");
            if (!Directory.Exists(logDir))
            {
                Logs = new List<LogEntry>();
                return;
            }

            var pattern = $"commandman-{SelectedLogFile}*.log";
            var files = Directory.GetFiles(logDir, pattern).OrderByDescending(f => f).ToList();
            
            if (files.Any())
            {
                var file = files.First();
                
                using (var fs = new FileStream(file, FileMode.Open, FileAccess.Read, FileShare.ReadWrite))
                using (var reader = new StreamReader(fs))
                {
                    var newLogs = new List<LogEntry>();
                    string? line;
                    LogEntry? currentEntry = null;

                    while ((line = reader.ReadLine()) != null)
                    {
                        if (line.Contains(" | "))
                        {
                            var parts = line.Split(" | ", 5);
                            if (parts.Length >= 5)
                            {
                                currentEntry = new LogEntry
                                {
                                    Timestamp = parts[0],
                                    Level = parts[1].Trim(),
                                    Source = parts[2].Trim(),
                                    Context = parts[3].Trim(),
                                    Message = parts[4]
                                };
                                newLogs.Add(currentEntry);
                            }
                        }
                        else if (currentEntry != null && !string.IsNullOrWhiteSpace(line))
                        {
                            // Append to exception if it's not a new structured line
                            currentEntry.Exception += (string.IsNullOrEmpty(currentEntry.Exception) ? "" : "\n") + line;
                        }
                    }
                    
                    Logs = newLogs.AsEnumerable().Reverse().Take(200).ToList();
                }
            }
            else
            {
                Logs = new List<LogEntry>();
            }
        }
        catch (Exception ex)
        {
             Logs = new List<LogEntry> { new LogEntry { Message = $"Error: {ex.Message}", Level = "ERR" } };
        }
    }

    private void ClearLogs()
    {
        try
        {
            var logDir = Path.Combine(Env.ContentRootPath, "logs");
            if (!Directory.Exists(logDir)) return;

            var pattern = $"commandman-{SelectedLogFile}*.log";
            var files = Directory.GetFiles(logDir, pattern).ToList();

            foreach (var file in files)
            {
                try
                {
                    using (new FileStream(file, FileMode.Truncate, FileAccess.Write, FileShare.ReadWrite))
                    {
                        // Just opening with FileMode.Truncate clears it
                    }
                }
                catch (IOException)
                {
                    // If file is locked or other IO issue, skip or log
                }
            }
            LoadLogs();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error clearing logs: {ex.Message}");
        }
    }
    
    private string GetLogLevelClass(string level)
    {
        return level switch
        {
            "ERR" or "FAT" => "level-err",
            "WRN" => "level-wrn",
            "INF" => "level-inf",
            "DBG" or "VRB" => "level-dbg",
            _ => ""
        };
    }

    public void Dispose()
    {
        _timer?.Dispose();
        ThemeService.OnThemeChanged -= StateHasChanged;
    }
}
